<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cub Scout Adventure Scope</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
	<style>
		.cloud-keyword { font-size: 1.2em; margin: 0.3em; display: inline-block; transition: background 0.2s, color 0.2s; cursor: pointer; border-radius: 0.3em; padding: 0.1em 0.5em; }
		.required { color: #3273dc; font-weight: bold; }
		.not-required { color: #23d160; }
		.tag-keyword { color: #ff3860; font-style: italic; }
		.cloud-keyword.selected.required {
			background: #3273dc;
			color: #fff !important;
			box-shadow: 0 0 0 2px #b5b5b5;
		}
		.cloud-keyword.selected.not-required {
			background: #23d160;
			color: #fff !important;
			box-shadow: 0 0 0 2px #b5b5b5;
		}
		.cloud-keyword.selected.tag-keyword {
			background: #ff3860;
			color: #fff !important;
			box-shadow: 0 0 0 2px #b5b5b5;
		}
	</style>
</head>
<body>
	<section class="section">
		<div class="container">
			<div class="is-flex is-align-items-center mb-2">
				<h1 class="title mr-3">Cub Scout Adventure Scope</h1>
				<button id="clear-btn" class="button is-small is-light">Clear</button>
			</div>
			<div id="keyword-cloud"></div>
		</div>
	</section>
	<script src="https://cdn.jsdelivr.net/npm/ractive@1.4.4/ractive.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
	<script>
		// Helper: fetch YAML file
		async function fetchYAML(url) {
			const res = await fetch(url);
			if (!res.ok) throw new Error('Failed to fetch YAML');
			return await res.text();
		}

		// Helper: extract keywords and requirements
		function extractKeywordsAndRequirements(data) {
			const requiredNames = new Set();
			const notRequiredNames = new Set();
			const tags = new Set();
			const requirements = [];
			if (!data.ranks) return { requiredNames, notRequiredNames, tags, requirements };
			data.ranks.forEach(rank => {
				if (!rank.adventure_list) return;
				rank.adventure_list.forEach(adv => {
					// alternate_name
					if (adv.alternate_name) {
						if (adv.required) requiredNames.add(adv.alternate_name);
						else notRequiredNames.add(adv.alternate_name);
					}
					// requirements tags
					if (adv.requirements) {
						adv.requirements.forEach(req => {
							if (req.tags && Array.isArray(req.tags)) {
								req.tags.forEach(tag => tags.add(tag));
							}
							requirements.push({
								adventure: adv.name,
								adventureAlt: adv.alternate_name || "",
								adventureRequired: !!adv.required,
								adventureUrl: adv.url,
								requirement: req.name,
								description: req.description || "",
								tags: req.tags || [],
								rank: rank.rank
							});
						});
					}
				});
			});
			// Remove empty tag
			tags.delete("");
			return { requiredNames, notRequiredNames, tags, requirements };
		}

		// Render cloud
		function renderCloud({ requiredNames, notRequiredNames, tags }) {
			const cloud = [];
			requiredNames.forEach(name => cloud.push({ text: name, type: 'required' }));
			notRequiredNames.forEach(name => cloud.push({ text: name, type: 'not-required' }));
			tags.forEach(tag => cloud.push({ text: tag, type: 'tag-keyword' }));
			return cloud;
		}


		// Filter requirements by selected cloud items and group by rank
		function filterRequirementsByRank(requirements, selectedCloud) {
			if (!selectedCloud.length) return {};
			const filtered = requirements.filter(req => {
				return selectedCloud.some(sel =>
					req.adventureAlt === sel.text ||
					req.adventure === sel.text ||
					req.tags.includes(sel.text)
				);
			});
			// Group by rank
			const grouped = {};
			filtered.forEach(req => {
				const rank = req.rank || "Unknown";
				if (!grouped[rank]) grouped[rank] = [];
				grouped[rank].push(req);
			});
			return grouped;
		}

		// Get up to 6 ranks in order of appearance
		function getRankOrder(requirements) {
			const order = [];
			requirements.forEach(req => {
				const rank = req.rank || "Unknown";
				if (!order.includes(rank)) order.push(rank);
			});
			return order.slice(0, 6);
		}

		// Main
		(async function() {
			try {
				const yamlText = await fetchYAML('data/adventure.yml');
				const data = jsyaml.load(yamlText);
				const { requiredNames, notRequiredNames, tags, requirements } = extractKeywordsAndRequirements(data);
				const cloud = renderCloud({ requiredNames, notRequiredNames, tags });


				const ractive = new Ractive({
					target: '#keyword-cloud',
					template: `
					<div>
						<div class="mb-4">
							{{#each cloud:i}}
								<span class="cloud-keyword {{type}} {{selectedCloud.includes(cloud[i]) ? 'selected' : ''}}"
									on-click="toggleCloud"
									data-index="{{i}}"
								>{{text}}</span>
							{{/each}}
						</div>
						<div id="requirements-grid">
							{{#if rankOrder.length}}
								<div class="columns is-multiline">
									{{#each rankOrder}}
										<div class="column is-one-sixth">
											<h2 class="subtitle has-text-weight-bold">{{.}}</h2>
											<ul>
												{{#each filteredRequirements[.]}}
													<li>
														<strong>{{adventure}}</strong><br>
														<a href="{{adventureUrl}}" target="_blank">{{requirement}}</a>: {{description}}
														{{#if tags.length}}
															<br><span class="tag is-light">{{tags.join(', ')}}</span>
														{{/if}}
													</li>
												{{/each}}
											</ul>
										</div>
									{{/each}}
								</div>
							{{else}}
								<p class="has-text-grey">Select a word cloud item to see matching requirements.</p>
							{{/if}}
						</div>
					</div>
					`,
					data: {
						cloud,
						selectedCloud: [],
						filteredRequirements: {},
						rankOrder: []
					},
					on: {
						toggleCloud(event) {
							const i = parseInt(event.node.getAttribute('data-index'), 10);
							const item = this.get('cloud')[i];
							let selected = this.get('selectedCloud').slice();
							const idx = selected.findIndex(sel => sel.text === item.text && sel.type === item.type);
							if (idx >= 0) selected.splice(idx, 1);
							else selected.push(item);
							this.set('selectedCloud', selected);
							const filtered = filterRequirementsByRank(requirements, selected);
							const order = getRankOrder(requirements.filter(req => {
								return selected.some(sel =>
									req.adventureAlt === sel.text ||
									req.adventure === sel.text ||
									req.tags.includes(sel.text)
								);
							}));
							this.set('filteredRequirements', filtered);
							this.set('rankOrder', order);
						}
					}
				});

				// Add clear button functionality
				document.getElementById('clear-btn').addEventListener('click', function() {
					ractive.set('selectedCloud', []);
					ractive.set('filteredRequirements', {});
					ractive.set('rankOrder', []);
				});
			} catch (e) {
				document.getElementById('keyword-cloud').innerHTML = '<p class="has-text-danger">Failed to load data.</p>';
				console.error(e);
			}
		})();
	</script>
</body>
</html>

